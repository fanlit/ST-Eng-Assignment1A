#!/bin/bash
#
#########
# Setup #
#########

DATETIME=$(date "+%d-%m-%y %r")
SUBJFILE='/etc/ssh/sshd_config'
KEY='PermitEmptyPasswords'
REQ='1B. Ensure SSH PermitEmptyPasswords is disabled'
#STDOUTLOGFILE="req"$REQ"_$(date "+%d-%m-%y").log"
STDOUTLOGFILE=$1
#STARTFAIL=0
#echo "" >> "$STDOUTLOGFILE"
#echo "# $REQ. Ensure SSH PermitEmptyPasswords is disabled  #########################" >> "$STDOUTLOGFILE"
#echo "Subject File: $SUBJFILE" >> "$STDOUTLOGFILE"
#echo "Key: $KEY" >> "$STDOUTLOGFILE"

#############################
# 1: Subject File not found #
#############################
if [ ! -f "$SUBJFILE" ]
then
        echo "[FAIL] $REQ, sshd_config not found, SSH cannot be started." >> "$STDOUTLOGFILE"
	exit 1
fi

####################
# 2: Key not found #
####################
if [ $( grep -i "^\s*$KEY\s*" "$SUBJFILE" | wc -l) -eq 0 ]
then
	echo "[FAIL] $REQ, $KEY key cannot be found." >> "$STDOUTLOGFILE"
	exit 1
fi

##########################
# 3: No associated value #
##########################
CMDOUT=$( grep -i "^\s*$KEY\s*" "$SUBJFILE" | grep -iE "^\s*$KEY\s*(#.*)*$" | wc -l)
if [ "$CMDOUT" -ne 0 ]
then
	echo "[FAIL] $REQ, $KEY has no value, SSH cannot be started" >> "$STDOUTLOGFILE"
	exit 1
fi

######################
# 4. Multiple values #
######################
CMDOUT=$( grep -iE "^\s*$KEY\s+" "$SUBJFILE" | grep -iP "^\s*$KEY\s+\S+\s+(?!\s*#)\S+" | wc -l)
if [ "$CMDOUT" -ne 0  ]
then
        echo "[FAIL] $REQ, $KEY has multiple values, SSH cannot be started" >> "$STDOUTLOGFILE"
        exit 1
fi

####################
# 5. Invalid value #
####################
CMDOUT=$( grep -iE "^\s*$KEY\s+" $SUBJFILE | grep -iPv "^\s*$KEY\s+(yes|no)(\s+#.*)?$" | wc -l)
if [ "$CMDOUT" -ne 0  ]
then
	echo "[FAIL] $REQ, $KEY has an invalid value, SSH cannot be started" >> "$STDOUTLOGFILE"
	exit 1
fi

##########################
# 6. Non-Compliant value #
##########################
CMDOUT=$( grep -iE "^\s*$KEY\s+" $SUBJFILE | head -1 | grep -iP "^\s*$KEY\s+(?!\s*no)\s*(#.*)*" | wc -l)
if [ "$CMDOUT" -ne 0 ]
then
        echo "[FAIL] $REQ, SSH $KEY is not disabled." >> "$STDOUTLOGFILE"
        exit 1
fi

######################
# 7. Compliant value #
######################
CMDOUT=$( grep -iE "^\s*$KEY\s+" $SUBJFILE | head -1 | grep -iE "^\s*$KEY\s+no\s*(#.*)*" | wc -l)
if [ "$CMDOUT" -eq 1 ]
then
        echo "[PASS] $REQ, SSH $KEY is disabled" >> "$STDOUTLOGFILE"
        exit 0
fi

#######################
# 8. Unexpected value #
#######################

echo "[FAIL] $REQ, $KEY has an unexpected value" >> "$STDOUTLOGFILE"
exit 1
